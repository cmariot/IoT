# Vagrant.configure("2") do |config|

#     # Shell command to run when the virtual machine is created
#     config.vm.provision "shell", inline: "echo Hello"

#     # Define the virtual machine configuration
#     config.vm.provider "vmware_desktop" do |v|
#         v.memory = 1024
#         v.cpus = 4
#         v.gui = "true"
#     end

#     # Server
#     config.vm.define "wloS" do |wloS|
#         wloS.vm.box = "bento/ubuntu-24.04"
#         wloS.vm.hostname = "wloS"
#     end

#     # Server Worker
#     config.vm.define "cmariotSW" do |cmariotSW|
#         cmariotSW.vm.box = "bento/ubuntu-24.04"
#         cmariotSW.vm.hostname = "cmariotSW"
#     end

# end

# Machine Settings
# https://developer.hashicorp.com/vagrant/docs/vagrantfile/machine_settings

# - config.vm.box (string) - This configures what box the machine will be brought up against. The value here should be the name of an installed box or a shorthand name of a box in HashiCorp's Vagrant Cloud.
# - config.vm.hostname
# - ...




# Installation
# https://sloopstash.com/blog/how-to-build-vm-on-apple-m1-m2-chip-mac-with-vmware-fusion-and-vagrant.html


Vagrant.configure("2") do |config|

    # Define the first VM: Server
    config.vm.define "wloS" do |server|
        server.vm.box = "bento/ubuntu-24.04"
        server.vm.hostname = "wloS"
        server.vm.network "private_network", ip: "192.168.56.110"
        server.vm.provider "vmware_fusion" do |vmware|
            vmware.memory = 512
            vmware.cpus = 1
            vmware.gui = true
        end
        server.vm.provision "shell", inline: <<-SHELL
            sudo echo "192.168.56.111 cmariotSW" >> /etc/hosts
            sudo apt-get update
            # Install k3s in controller mode
            # Install kubectl
        SHELL
    end

    # Define the second VM: ServerWorker
    config.vm.define "cmariotSW" do |serverWorker|
        serverWorker.vm.box = "bento/ubuntu-24.04"
        serverWorker.vm.hostname = "cmariotSW"
        serverWorker.vm.network "private_network", ip: "192.168.56.111"
        serverWorker.vm.provider "vmware_fusion" do |vmware|
            vmware.memory = 512
            vmware.cpus = 1
            vmware.gui = true
        end
            serverWorker.vm.provision "shell", inline: <<-SHELL
            sudo echo "192.168.56.110 wloS" >> /etc/hosts
            sudo apt-get update
            # Install k3s in agent mode
            # Install kubectl
        SHELL
    end

    # SSH Configuration for passwordless login
    config.ssh.insert_key = false
    config.vm.provision "shell", inline: <<-SHELL
        ssh-keygen -t rsa -b 4096 -f /home/vagrant/.ssh/id_rsa -N ""
        cat /home/vagrant/.ssh/id_rsa.pub >> /home/vagrant/.ssh/authorized_keys
        chmod 600 /home/vagrant/.ssh/authorized_keys
    SHELL

end


# Check the IP address of the VMs
# vagrant ssh Server -c "ip a show eth1"
# ip addr show eth1


# Documentation :
# Vagrantfile : https://developer.hashicorp.com/vagrant/docs/vagrantfile
# Multi-Machine : https://developer.hashicorp.com/vagrant/docs/multi-machine
# Providers : https://developer.hashicorp.com/vagrant/docs/providers
# Machine Settings : https://developer.hashicorp.com/vagrant/docs/vagrantfile/machine_settings
# Private Networks : https://developer.hashicorp.com/vagrant/docs/networking/private_network
# SSH Settings : https://developer.hashicorp.com/vagrant/docs/vagrantfile/ssh_settings
# Shell Provisioner : https://developer.hashicorp.com/vagrant/docs/provisioning/shell